<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">
<!-- BEGIN: Head-->

<head>
  <%- include('_layouts/head') %>
  <title>Dashboard | <%= title %>
  </title>
  <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<!-- END: Head-->

<body class="vertical-layout page-header-light vertical-menu-collapsible vertical-dark-menu preload-transitions 2-columns" data-open="click" data-menu="vertical-dark-menu" data-col="2-columns">

  <%- include('_layouts/sidenavbar') %>

  <!-- BEGIN: Page Main-->
  <div id="main ">
    <div class="row dashboard">
      <div class="col s12">
        <div class="container">
          <div class="section">
            <!--card stats start-->
            <div id="card-stats" class="pt-0">
              <div class="row">
              </div>
              <%- include('messages', { messages: messages }) %>
              <div class="row mt-2">

                <div class="col m3 s12" style="padding: 10px;">
                  <a href="/admin/user" style="text-decoration: none;">
                    <div style="background-color: #1A9CFF; border-radius: 20px; padding: 10px 10px 20px 30px;">
                      <h4 style="font-size: 40px; color: #FFFFFF; font-weight: 900;" class="counter" data-target="<%= data.user %>">
                        <!-- The counter number will be inserted dynamically -->
                      </h4>
                      <span style="font-size: 22px; color: #FFFFFF;">Total Users</span>
                    </div>
                  </a>
                </div>

                <div class="col m3 s12" style="padding: 10px;">
                  <a href="/admin/vendor" style="text-decoration: none;">
                    <div style="background-color: #5139DB; border-radius: 20px; padding: 10px 10px 20px 30px;">
                      <h4 style="font-size: 40px; color: #FFFFFF; font-weight: 900;" class="counter" data-target="<%= data.vendor %>">
                        <!-- The counter number will be inserted dynamically -->
                      </h4>
                      <span style="font-size: 22px; color: #FFFFFF;">Total Vendors</span>
                    </div>
                  </a>
                </div>

                <div class="col m3 s12" style="padding: 10px;">
                  <a href="/admin/user" style="text-decoration: none;">
                    <div style="background-color: #31B411; border-radius: 20px; padding: 10px 10px 20px 30px;">
                      <h4 style="font-size: 40px; color: #FFFFFF; font-weight: 900;" class="counter" data-target="<%= data.totalEarnPoints %>">
                        <!-- The counter number will be inserted dynamically -->
                      </h4>
                      <span style="font-size: 22px; color: #FFFFFF;">Total Earn Points</span>
                    </div>
                  </a>
                </div>

                <div class="col m3 s12" style="padding: 10px;">
                  <a href="/admin/user" style="text-decoration: none;">
                    <div style="background-color: #FF531A; border-radius: 20px; padding: 10px 10px 20px 30px;">
                      <h4 style="font-size: 40px; color: #FFFFFF; font-weight: 900;" class="counter" data-target="<%= data.totalRedeemPoints %>">
                        <!-- The counter number will be inserted dynamically -->
                      </h4>
                      <span style="font-size: 22px; color: #FFFFFF;">Total Redeem Points</span>
                    </div>
                  </a>
                </div>

              </div>
            </div>
          </div>

          <!-- DASHBOARD REPORTS -->
          <div class="row mt-2">

            <div class="col s12 m6">
              <div class="card">
                <div class="card-content">
                  <h5 class="purple-text">Top 5 Vendors</h5>
                  <% if (topVendors && topVendors.length > 0) { %>
                  <% topVendors.forEach((v, i) => { %>
                  <div style="padding: 10px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex;align-items:center;">
                      <div style="width:36px;height:36px;border-radius:50%;background:<%= i===0?'#FFD700':i===1?'#C0C0C0':i===2?'#CD7F32':'#667eea' %>;color:white;font-weight:bold;display:flex;align-items:center;justify-content:center;margin-right:12px;"> <%= i+1 %> </div>
                      <div>
                        <strong><%= v.vendorName %></strong><br>
                        <small><%= v.totalRedemptions %> redemptions â€¢ <%= v.totalTransactions %> orders</small>
                      </div>
                    </div>
                    <div><strong style="color:#2e7d32"><%= v.totalDiscountBHD %> BHD</strong></div>
                  </div>
                  <% }) %>
                  <% } else { %>
                  <div class="center grey-text">No vendor data</div>
                  <% } %>
                </div>
              </div>
            </div>

            <div class="col s12 m6">
              <div class="card">
                <div class="card-content">
                  <h5 class="purple-text">Top 5 Users</h5>
                  <% if (topOfferUsers && topOfferUsers.length > 0) { %>
                  <% topOfferUsers.forEach((u, i) => { %>
                  <div style="padding: 10px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                      <strong><%= u.name || 'Guest' %></strong><br>
                      <small><%= u.mobile || '' %></small>
                    </div>
                    <div style="text-align:right;">
                      <div><strong><%= u.offersCount %></strong> offers</div>
                      <div class="green-text"><strong><%= u.totalDiscount %> BHD</strong></div>
                    </div>
                  </div>
                  <% }) %>
                  <% } else { %>
                  <div class="center grey-text">No offer user data</div>
                  <% } %>
                </div>
              </div>
            </div>

          </div>

          <div class="row mt-2">
            <div class="col s12">
              <div class="card" style="height:100%;">
                <div class="card-content">
                  <h5 class="purple-text">Point Redemption Trend</h5>
                  <div style="height:420px;">
                    <canvas id="redemptionChart" height="420" style="height:100%; width:100%;"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!--end container-->
      </div>
    </div>
  </div>
  </div>
  </div>
  <!-- END: Page Main-->
  <%- include('_layouts/commonJs') %>

  <script>
    jQuery(document).ready(function($) {
      $(".clickable-row").click(function() {
        window.location = $(this).data("href");
      });
    });

    // script.js
    document.addEventListener('DOMContentLoaded', () => {
      const counters = document.querySelectorAll('.counter');

      counters.forEach(counter => {
        const updateCounter = () => {
          const target = +counter.getAttribute('data-target');
          let count = 0;
          const interval = setInterval(() => {
            count += Math.ceil(target / 100);
            if (count >= target) {
              count = target;
              clearInterval(interval);
            }
            counter.textContent = count;
          }, 10);
        };
        updateCounter();
      });

      // Render redemption chart (if data available)
      try {
        const labels = [<%- (redemptionTrend || []).map(d => `'${d._id}'`).join(',') %>];
        const dataPoints = [<%- (redemptionTrend || []).map(d => d.points || 0).join(',') %>];
        if (labels.length && document.getElementById('redemptionChart')) {
          const ctx = document.getElementById('redemptionChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Points Redeemed',
                data: dataPoints,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 4
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'top'
                },
                title: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }
      } catch (err) {
        console.error('Chart render error', err);
      }

    });
  </script>
</body>

</html>